# Messages Feature - Production Architecture

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
src/features/messages/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ MessagesPage.jsx          # –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ ConversationsSidebar.jsx  # –°–∞–π–¥–±–∞—Ä –∑ —Ä–æ–∑–º–æ–≤–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ ConversationItem.jsx      # –ï–ª–µ–º–µ–Ω—Ç —Ä–æ–∑–º–æ–≤–∏ (–º–µ–º–æ—ñ–∑–æ–≤–∞–Ω–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ ChatArea.jsx              # –û–±–ª–∞—Å—Ç—å —á–∞—Ç—É
‚îÇ   ‚îú‚îÄ‚îÄ ChatHeader.jsx            # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç—É
‚îÇ   ‚îú‚îÄ‚îÄ MessagesList.jsx          # –°–ø–∏—Å–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
‚îÇ   ‚îú‚îÄ‚îÄ MessageBubble.jsx         # –ë—É–ª—å–±–∞—à–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–º–µ–º–æ—ñ–∑–æ–≤–∞–Ω–∞)
‚îÇ   ‚îú‚îÄ‚îÄ MessageInput.jsx          # –ü–æ–ª–µ –≤–≤–æ–¥—É
‚îÇ   ‚îú‚îÄ‚îÄ NewChatModal.jsx          # –ú–æ–¥–∞–ª–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É (Portal)
‚îÇ   ‚îî‚îÄ‚îÄ index.js                  # –ï–∫—Å–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useConversations.js       # –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–º–æ–≤–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ useMessagesSocket.js      # WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
‚îÇ   ‚îú‚îÄ‚îÄ useTyping.js              # –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–∏–ø—ñ–Ω–≥–æ–º
‚îÇ   ‚îî‚îÄ‚îÄ index.js                  # –ï–∫—Å–ø–æ—Ä—Ç —Ö—É–∫—ñ–≤
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ messagesService.js        # API —Å–µ—Ä–≤—ñ—Å
‚îî‚îÄ‚îÄ index.js                      # –ì–æ–ª–æ–≤–Ω–∏–π –µ–∫—Å–ø–æ—Ä—Ç
```

## üéØ –ö–ª—é—á–æ–≤—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏

### ‚úÖ –©–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

- **–ß–∏—Å—Ç–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞**: –†–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –ª–æ–≥—ñ—á–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
- **React.memo**: –ú–µ–º–æ—ñ–∑–∞—Ü—ñ—è –¥–ª—è ConversationItem —Ç–∞ MessageBubble
- **useMemo/useCallback**: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–ª—è —Å–ø–∏—Å–∫—ñ–≤ —Ç–∞ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
- **–ö–∞—Å—Ç–æ–º–Ω—ñ —Ö—É–∫–∏**: –í–∏–Ω–µ—Å–µ–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏
- **Portal –¥–ª—è –º–æ–¥–∞–ª–æ–∫**: –ü—Ä–∞–≤–∏–ª—å–Ω–µ —Ä–µ–Ω–¥–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–≤–µ—Ä—Ö –∫–æ–Ω—Ç–µ–Ω—Ç—É
- **–û–¥–∏–Ω source of truth**: –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è activeChat
- **–ß–∏—Å—Ç—ñ CSS —Å—Ç–∏–ª—ñ**: –ë–µ–∑ !important, –±–µ–∑ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤
- **BEM naming**: –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è —ñ–º–µ–Ω—É–≤–∞–Ω–Ω—è
- **–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è**: ESC –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–æ–∫
- **–ú–µ–º–æ—ñ–∑–æ–≤–∞–Ω—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏**: filteredConversations, activeConversation

### üö´ –©–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ

- ‚ùå –ü—Ä–∏–±—Ä–∞–Ω–æ forceUpdate
- ‚ùå –ú—ñ–Ω—ñ–º—ñ–∑–æ–≤–∞–Ω–æ useEffect
- ‚ùå –ü—Ä–∏–±—Ä–∞–Ω–æ console.log
- ‚ùå –ü—Ä–∏–±—Ä–∞–Ω–æ side-effects —É render
- ‚ùå –ü—Ä–∏–±—Ä–∞–Ω–æ position: fixed –¥–ª—è –º–µ–Ω—é
- ‚ùå –ü—Ä–∏–±—Ä–∞–Ω–æ !important –∑—ñ —Å—Ç–∏–ª—ñ–≤
- ‚ùå –ü—Ä–∏–±—Ä–∞–Ω–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏ —Å—Ç–∏–ª—ñ–≤

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### MessagesPage
–ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∑ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è–º —Å—Ç–∞–Ω—É —Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—î—é –¥–æ—á—ñ—Ä–Ω—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤.

**Props**: –û—Ç—Ä–∏–º—É—î userId –∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤

**State**:
- `activeChat` - ID –∞–∫—Ç–∏–≤–Ω–æ—ó —Ä–æ–∑–º–æ–≤–∏
- `showNewChatModal` - —Å—Ç–∞–Ω –º–æ–¥–∞–ª–∫–∏
- `searchQuery` - –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç

### ConversationsSidebar
–ú–µ–º–æ—ñ–∑–æ–≤–∞–Ω–∏–π —Å–∞–π–¥–±–∞—Ä –∑—ñ —Å–ø–∏—Å–∫–æ–º —Ä–æ–∑–º–æ–≤.

**Props**:
- `conversations` - —Å–ø–∏—Å–æ–∫ —Ä–æ–∑–º–æ–≤
- `activeChat` - ID –∞–∫—Ç–∏–≤–Ω–æ—ó —Ä–æ–∑–º–æ–≤–∏
- `onConversationSelect` - –æ–±—Ä–æ–±–Ω–∏–∫ –≤–∏–±–æ—Ä—É —Ä–æ–∑–º–æ–≤–∏

### MessagesList
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø–∏—Å–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–æ—é –¥–æ –≤—ñ—Ä—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—ó.

**Features**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- –ú–µ–º–æ—ñ–∑–æ–≤–∞–Ω—ñ MessageBubble –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
- –ü—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –¥–ª—è react-window

### NewChatModal
–ú–æ–¥–∞–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É —á–µ—Ä–µ–∑ Portal.

**Features**:
- –†–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ createPortal
- –ó–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –ø–æ ESC —Ç–∞ –∫–ª—ñ–∫—É –ø–æ–∑–∞
- –ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ debounce

## üé£ –•—É–∫–∏

### useConversations
–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–ø–∏—Å–∫–æ–º —Ä–æ–∑–º–æ–≤ –∑ –º–µ–º–æ—ñ–∑–æ–≤–∞–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏.

```javascript
const {
  conversations,
  loading,
  error,
  updateConversation,
  addConversation,
  removeConversation,
  markAsRead,
  incrementUnread
} = useConversations()
```

### useMessagesSocket
WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–¥—ñ–π.

```javascript
const { sendTyping } = useMessagesSocket({
  activeChat,
  currentUserId,
  onNewMessage,
  onUserTyping,
  onUserOnline,
  onUserOffline
})
```

### useTyping
–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –¥—Ä—É–∫—É–≤–∞–Ω–Ω—è.

```javascript
const {
  isTyping,
  typingUsers,
  startTyping,
  handleUserTyping
} = useTyping(sendTypingCallback)
```

## üé® CSS –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

### –ü—Ä–∏–Ω—Ü–∏–ø–∏
- **BEM methodology**: `.block__element--modifier`
- **CSS Variables**: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è design tokens
- **No !important**: –ñ–æ–¥–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
- **No duplicates**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—ñ–≤
- **Mobile-first**: Responsive –¥–∏–∑–∞–π–Ω

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∏–ª—ñ–≤
```css
/* Base components */
.messages-page {}
.conversations-sidebar {}
.chat-area {}

/* Elements */
.conversation {}
.conversation__avatar {}
.conversation__info {}
.conversation--active {}

/* Modifiers */
.message--me {}
.message--other {}
```

## üöÄ Performance

### –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
- **React.memo** –¥–ª—è —Å–ø–∏—Å–∫—ñ–≤
- **useMemo** –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö
- **useCallback** –¥–ª—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
- **Lazy loading** –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
- **Debounce** –¥–ª—è –ø–æ—à—É–∫—É
- **Portal** –¥–ª—è –º–æ–¥–∞–ª–æ–∫

### –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –≤—ñ—Ä—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
MessagesList –≥–æ—Ç–æ–≤–∏–π –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ react-window:

```javascript
// –ú–∞–π–±—É—Ç–Ω—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è
import { FixedSizeList as List } from 'react-window'

const VirtualizedMessagesList = ({ messages }) => (
  <List
    height={280}
    itemCount={messages.length}
    itemSize={60}
    itemData={messages}
  >
    {MessageBubble}
  </List>
)
```

## üîí Security & Best Practices

- **Input validation**: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—ñ–≤ —Ç–∞ —Ä–æ–∑–º—ñ—Ä—ñ–≤
- **XSS protection**: –ë–µ–∑–ø–µ—á–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É
- **Error boundaries**: –ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫
- **Memory leaks prevention**: –ü—Ä–∞–≤–∏–ª—å–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è listeners
- **Token management**: –ë–µ–∑–ø–µ—á–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤

## üì± Responsive Design

- **Mobile-first**: –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π –¥–∏–∑–∞–π–Ω
- **Breakpoints**: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è CSS –∑–º—ñ–Ω–Ω–∏—Ö
- **Touch-friendly**: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤

## üß™ –ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è:
- **Unit tests**: –Ü–∑–æ–ª—å–æ–≤–∞–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
- **Integration tests**: –•—É–∫–∏ —Ç–∞ —Å–µ—Ä–≤—ñ—Å–∏
- **E2E tests**: –ü–æ–≤–Ω–∏–π user flow

## üîÑ –ú–∞–π–±—É—Ç–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

1. **–í—ñ—Ä—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—è**: –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è react-window
2. **WebSocket**: –ü–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è real-time
3. **Offline support**: PWA –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ
4. **TypeScript**: –¢–∏–ø—ñ–∑–∞—Ü—ñ—è
5. **Storybook**: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤